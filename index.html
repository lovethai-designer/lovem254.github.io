<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loveth AI Designer</title>
    <!-- Tailwind CSS from CDN for easy deployment -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- MathJax for LaTeX Rendering -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #334155;
            line-height: 1.6;
        }

        .prose pre {
            background-color: #f8fafc;
            border-left: 4px solid #6366f1;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .prose code {
            font-family: 'Roboto Mono', monospace;
            background-color: #e2e8f0;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
        }

        .prose h1, .prose h2, .prose h3 {
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
            margin-top: 1.5rem;
            font-weight: 600;
        }

        .prose table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .prose th, .prose td {
            border: 1px solid #e2e8f0;
            padding: 0.75rem;
            text-align: left;
        }

        .prose th {
            background-color: #f1f5f9;
        }

        .prose ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center p-4 min-h-screen">

    <div class="max-w-4xl w-full bg-white rounded-xl shadow-lg p-6 md:p-8 space-y-6">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                <i class="fas fa-palette text-blue-500 mr-3"></i>
                Loveth AI Designer
            </h1>
            <div class="flex space-x-2 mt-4 md:mt-0">
                <button id="downloadImageButton" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition-colors">
                    <i class="fas fa-image mr-2"></i>
                    Download Image
                </button>
                <button id="downloadPdfButton" class="px-4 py-2 bg-purple-500 text-white font-semibold rounded-lg shadow-md hover:bg-purple-600 transition-colors">
                    <i class="fas fa-file-pdf mr-2"></i>
                    Download PDF
                </button>
                <button id="clearRenderButton" class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition-colors">
                    <i class="fas fa-broom mr-2"></i>
                    Clear Render
                </button>
            </div>
        </div>

        <!-- Render View and User Input -->
        <div class="relative w-full aspect-video border-4 border-gray-300 rounded-lg overflow-hidden shadow-inner bg-gray-200 flex items-center justify-center">
            <img id="renderImageView" class="w-full h-full object-contain p-2" src="https://placehold.co/1280x720/e2e8f0/94a3b8?text=Your+AI+Render+Here" alt="AI Generated Render">
            <div id="loadingIndicator" class="absolute inset-0 bg-gray-900 bg-opacity-70 flex flex-col items-center justify-center text-white text-lg font-semibold hidden">
                <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                <p>Generating...</p>
            </div>
            <div id="messageBox" class="absolute top-4 w-auto max-w-sm p-4 rounded-lg text-white font-semibold shadow-xl transition-opacity duration-300 opacity-0 hidden"></div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Left Side: Prompt Input and Image Upload -->
            <div class="space-y-4">
                <textarea id="promptInput" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow resize-none" placeholder="Enter a detailed design concept here (e.g., 'A sleek, minimalist kitchen with a large island, warm lighting, and natural wood accents')."></textarea>
                <div class="flex items-center justify-between space-x-2">
                    <button id="generateRenderButton" class="w-full px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                        <i class="fas fa-magic mr-2"></i>
                        Generate AI Render
                    </button>
                    <input type="file" id="imageUpload" accept="image/png, image/jpeg" class="hidden">
                    <button id="uploadImageButton" class="px-4 py-3 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md hover:bg-gray-400 transition-colors">
                        <i class="fas fa-upload"></i>
                    </button>
                </div>
            </div>

            <!-- Right Side: Structural Analysis and Output -->
            <div class="space-y-4">
                <div class="flex items-center space-x-2">
                    <button id="structuralAnalysisButton" class="w-full px-4 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors">
                        <i class="fas fa-search mr-2"></i>
                        Perform Structural Analysis
                    </button>
                    <div class="w-auto px-4 py-3 bg-gray-300 text-gray-800 font-semibold rounded-lg shadow-md flex items-center justify-center">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                </div>
                <div id="structuralOutputContainer" class="p-4 bg-white rounded-lg shadow-inner border border-gray-300 min-h-[100px] overflow-auto">
                    <p class="text-gray-500">Analysis results will appear here after you upload an image and click 'Perform Structural Analysis'.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const renderImageView = document.getElementById('renderImageView');
        const promptInput = document.getElementById('promptInput');
        const generateRenderButton = document.getElementById('generateRenderButton');
        const imageUpload = document.getElementById('imageUpload');
        const uploadImageButton = document.getElementById('uploadImageButton');
        const structuralAnalysisButton = document.getElementById('structuralAnalysisButton');
        const structuralOutputContainer = document.getElementById('structuralOutputContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageBox = document.getElementById('messageBox');
        const downloadPdfButton = document.getElementById('downloadPdfButton');
        const downloadImageButton = document.getElementById('downloadImageButton');
        const clearRenderButton = document.getElementById('clearRenderButton');

        let uploadedImageBase64 = null;
        let analysisReportText = '';
        let renderImageSrc = '';

        const apiKey = ""; // The API key will be provided by the canvas environment

        function showMessageBox(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = `absolute top-4 w-auto max-w-sm p-4 rounded-lg text-white font-semibold shadow-xl transition-opacity duration-300 opacity-100 block ${
                type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-gray-700'
            }`;
            setTimeout(() => {
                messageBox.className = messageBox.className.replace('opacity-100', 'opacity-0');
            }, 3000);
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3300);
        }

        async function fetchWithRetry(url, payload) {
            const maxRetries = 3;
            let retries = 0;
            let response = null;

            do {
                try {
                    response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return response;
                    } else {
                        throw new Error(`API returned status code: ${response.status}`);
                    }
                } catch (error) {
                    retries++;
                    console.error(`Fetch attempt ${retries} failed:`, error);
                    if (retries < maxRetries) {
                        const delay = Math.pow(2, retries) * 1000;
                        console.log(`Retrying in ${delay / 1000} seconds...`);
                        await new Promise(res => setTimeout(res, delay));
                    } else {
                        throw error;
                    }
                }
            } while (retries < maxRetries);

            throw new Error("Failed to fetch data after multiple retries.");
        }

        uploadImageButton.addEventListener('click', () => {
            imageUpload.click();
        });

        imageUpload.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result;
                const base64Data = base64.split(',')[1];
                uploadedImageBase64 = base64Data;
                renderImageView.src = base64;
                showMessageBox('Image uploaded successfully!', 'success');
            };
            reader.readAsDataURL(file);
        });

        generateRenderButton.addEventListener('click', async () => {
            const userPrompt = promptInput.value.trim();

            let inputImageBase64 = uploadedImageBase64;
            // Use the last rendered image as input if it exists and is not the placeholder
            if (renderImageSrc && !renderImageSrc.includes('placehold.co')) {
                inputImageBase64 = renderImageSrc.split(',')[1];
            }
            
            if (!inputImageBase64) {
                showMessageBox('Please upload an image to render first.', 'error');
                return;
            }

            loadingIndicator.classList.remove('hidden');
            renderImageView.style.opacity = '0.5';

            try {
                // Construct a new, more detailed prompt for greater drawing fidelity
                const fidelityPrompt = "Render the design with the requested style, maintaining the exact layout, geometry, and all original entry points and structural elements without any changes or additions.";
                const combinedPrompt = userPrompt ? `${userPrompt}. ${fidelityPrompt}` : fidelityPrompt;

                // The gemini-2.5-flash-image-preview model is used for image-to-image generation.
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{
                        parts: [
                            { text: combinedPrompt },
                            { inlineData: { mimeType: 'image/png', data: inputImageBase64 } }
                        ]
                    }],
                    generationConfig: {
                        responseModalities: ['IMAGE', 'TEXT']
                    },
                };
                
                const response = await fetchWithRetry(apiUrl, payload);
                const result = await response.json();
                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (!base64Data) {
                    throw new Error('No image data received from API.');
                }

                renderImageSrc = `data:image/png;base64,${base64Data}`;
                renderImageView.src = renderImageSrc;
                showMessageBox('Render generated successfully!', 'success');

            } catch (error) {
                console.error("Error generating render:", error);
                showMessageBox(`Error: ${error.message}`, 'error');
            } finally {
                loadingIndicator.classList.add('hidden');
                renderImageView.style.opacity = '1';
            }
        });

        structuralAnalysisButton.addEventListener('click', async () => {
            const userPrompt = "Analyze the structural and design elements of the image, including geometry, materials, and potential engineering challenges. Provide the analysis report in Markdown format, using LaTeX for all mathematical expressions. Do not use conversational filler, just provide the analysis report.";
            
            let analysisImageBase64 = uploadedImageBase64;
            if (renderImageSrc && !renderImageSrc.includes('placehold.co')) {
                analysisImageBase64 = renderImageSrc.split(',')[1];
            }

            if (!analysisImageBase64) {
                showMessageBox('Please upload an image first.', 'error');
                return;
            }

            loadingIndicator.classList.remove('hidden');
            renderImageView.style.opacity = '0.5';

            try {
                const payload = {
                    contents: [{
                        parts: [
                            { text: userPrompt },
                            { inlineData: { mimeType: 'image/png', data: analysisImageBase64 } }
                        ]
                    }],
                    model: 'gemini-2.5-flash-preview-05-20'
                };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetchWithRetry(apiUrl, payload);
                const result = await response.json();
                const analysisText = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'No analysis could be performed.';

                analysisReportText = analysisText;
                let formattedOutput = marked.parse(analysisReportText);
                
                structuralOutputContainer.innerHTML = `<div class="p-4 bg-white rounded-lg shadow-md mt-4 prose max-w-none">${formattedOutput}</div>`;

                // Trigger MathJax rendering
                if (window.MathJax) {
                    window.MathJax.typesetPromise();
                }

            } catch (error) {
                console.error("Error performing structural analysis:", error);
                structuralOutputContainer.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-lg">Error: ${error.message}</div>`;
            } finally {
                loadingIndicator.classList.add('hidden');
                renderImageView.style.opacity = '1';
            }
        });

        downloadPdfButton.addEventListener('click', () => {
            if (!renderImageSrc && !analysisReportText) {
                showMessageBox('No report or render to download.', 'error');
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text("AI Designer Report", 10, 10);

            let yOffset = 20;

            if (renderImageSrc) {
                const img = new Image();
                img.onload = () => {
                    const imgWidth = 180;
                    const imgHeight = (img.height * imgWidth) / img.width;
                    if (yOffset + imgHeight > 280) { // Check if new page is needed
                        doc.addPage();
                        yOffset = 20;
                    }
                    doc.addImage(img, 'JPEG', 15, yOffset, imgWidth, imgHeight);
                    yOffset += imgHeight + 10;
                    addTextToPdf(doc, analysisReportText, yOffset);
                    doc.save("Loveth_AI_Designer_Report.pdf");
                };
                img.src = renderImageSrc;
            } else {
                addTextToPdf(doc, analysisReportText, yOffset);
                doc.save("Loveth_AI_Designer_Report.pdf");
            }
        });

        downloadImageButton.addEventListener('click', () => {
            const imageSrc = renderImageView.src;
            if (imageSrc.includes('placehold.co')) {
                showMessageBox('No image to download. Please generate a render first.', 'error');
                return;
            }
            
            const link = document.createElement('a');
            link.href = imageSrc;
            link.download = 'Loveth_AI_Render.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessageBox('Image download started!', 'success');
        });

        clearRenderButton.addEventListener('click', () => {
            // Reset state variables
            uploadedImageBase64 = null;
            renderImageSrc = '';
            analysisReportText = '';

            // Reset UI elements to their initial state
            renderImageView.src = 'https://placehold.co/1280x720/e2e8f0/94a3b8?text=Your+AI+Render+Here';
            structuralOutputContainer.innerHTML = `<p class="text-gray-500">Analysis results will appear here after you upload an image and click 'Perform Structural Analysis'.</p>`;
            
            showMessageBox('Render and analysis cleared. Please upload a new image.', 'success');

            // Trigger the file upload dialog
            imageUpload.click();
        });

        function addTextToPdf(doc, text, yOffset) {
            if (text) {
                doc.setFontSize(12);
                const lines = doc.splitTextToSize(text, 180);
                lines.forEach(line => {
                    if (yOffset > 280) { // Check if new page is needed
                        doc.addPage();
                        yOffset = 20;
                    }
                    doc.text(line, 15, yOffset);
                    yOffset += 7; // Line height
                });
            }
        }
    </script>
</body>
</html>
