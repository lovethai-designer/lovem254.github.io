<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loveth AI Designer</title>
    <!-- Tailwind CSS from CDN for easy deployment -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- MathJax for LaTeX Rendering -->
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
            color: #334155;
            line-height: 1.6;
        }

        .prose pre {
            background-color: #f8fafc;
            border-left: 4px solid #6366f1;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .prose code {
            font-family: 'Roboto Mono', monospace;
            background-color: #e2e8f0;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
        }

        .prose h1, .prose h2, .prose h3 {
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 0.5rem;
            margin-top: 1.5rem;
            font-weight: 600;
        }

        .prose table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .prose th, .prose td {
            border: 1px solid #e2e8f0;
            padding: 0.75rem;
            text-align: left;
        }

        .prose th {
            background-color: #f1f5f9;
        }

        .prose ul {
            list-style-type: disc;
            padding-left: 1.5rem;
        }
        
        .thumbnail-image {
            cursor: pointer;
            border: 4px solid transparent;
            transition: border-color 0.3s;
        }
        .thumbnail-image.active {
            border-color: #3b82f6; /* blue-500 */
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col items-center justify-center p-4 min-h-screen">

    <div class="max-w-4xl w-full bg-white rounded-xl shadow-lg p-6 md:p-8 space-y-6">
        <div class="flex flex-col md:flex-row justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800 flex items-center">
                <i class="fas fa-palette text-blue-500 mr-3"></i>
                Loveth AI Designer
            </h1>
            <div class="flex space-x-2 mt-4 md:mt-0">
                <button id="downloadImageButton" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 transition-colors">
                    <i class="fas fa-image mr-2"></i>
                    Download Image
                </button>
                <button id="downloadPdfButton" class="px-4 py-2 bg-purple-500 text-white font-semibold rounded-lg shadow-md hover:bg-purple-600 transition-colors">
                    <i class="fas fa-file-pdf mr-2"></i>
                    Download PDF
                </button>
                <button id="clearRenderButton" class="px-4 py-2 bg-gray-500 text-white font-semibold rounded-lg shadow-md hover:bg-gray-600 transition-colors">
                    <i class="fas fa-broom mr-2"></i>
                    Clear Render
                </button>
            </div>
        </div>

        <!-- Render View and User Input -->
        <div class="relative w-full aspect-video border-4 border-gray-300 rounded-lg overflow-hidden shadow-inner bg-gray-200 flex items-center justify-center">
            <img id="renderImageView" class="w-full h-full object-contain p-2" src="https://placehold.co/1280x720/e2e8f0/94a3b8?text=Your+AI+Render+Here" alt="AI Generated Render">
            <div id="loadingIndicator" class="absolute inset-0 bg-gray-900 bg-opacity-70 flex flex-col items-center justify-center text-white text-lg font-semibold hidden">
                <i class="fas fa-spinner fa-spin text-4xl mb-4"></i>
                <p>Generating...</p>
            </div>
            <div id="messageBox" class="absolute top-4 w-auto max-w-sm p-4 rounded-lg text-white font-semibold shadow-xl transition-opacity duration-300 opacity-0 hidden"></div>
        </div>

        <!-- Elevation Management -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 bg-gray-200 p-4 rounded-lg">
            <!-- Front Elevation -->
            <div class="text-center">
                <p class="font-semibold text-gray-700">Front Elevation</p>
                <div id="front-thumb-container" class="mt-2 w-full h-24 bg-white rounded-lg flex items-center justify-center border-2 border-dashed cursor-pointer" onclick="setActiveElevation('front')">
                    <span class="text-gray-400 text-sm pointer-events-none">Upload Image</span>
                </div>
                <input type="file" id="front-upload-input" class="hidden" accept="image/png, image/jpeg">
                <button id="upload-front-button" class="mt-2 w-full px-2 py-1 bg-gray-500 text-white text-xs font-semibold rounded-lg hover:bg-gray-600 transition-colors">Upload</button>
            </div>
            <!-- Rear Elevation -->
            <div class="text-center">
                <p class="font-semibold text-gray-700">Rear Elevation</p>
                <div id="rear-thumb-container" class="mt-2 w-full h-24 bg-white rounded-lg flex items-center justify-center border-2 border-dashed cursor-pointer" onclick="setActiveElevation('rear')">
                     <span class="text-gray-400 text-sm pointer-events-none">Upload Image</span>
                </div>
                <input type="file" id="rear-upload-input" class="hidden" accept="image/png, image/jpeg">
                <button id="upload-rear-button" class="mt-2 w-full px-2 py-1 bg-gray-500 text-white text-xs font-semibold rounded-lg hover:bg-gray-600 transition-colors">Upload</button>
            </div>
            <!-- Left Elevation -->
            <div class="text-center">
                <p class="font-semibold text-gray-700">Left Elevation</p>
                <div id="left-thumb-container" class="mt-2 w-full h-24 bg-white rounded-lg flex items-center justify-center border-2 border-dashed cursor-pointer" onclick="setActiveElevation('left')">
                     <span class="text-gray-400 text-sm pointer-events-none">Upload Image</span>
                </div>
                <input type="file" id="left-upload-input" class="hidden" accept="image/png, image/jpeg">
                <button id="upload-left-button" class="mt-2 w-full px-2 py-1 bg-gray-500 text-white text-xs font-semibold rounded-lg hover:bg-gray-600 transition-colors">Upload</button>
            </div>
            <!-- Right Elevation -->
            <div class="text-center">
                <p class="font-semibold text-gray-700">Right Elevation</p>
                <div id="right-thumb-container" class="mt-2 w-full h-24 bg-white rounded-lg flex items-center justify-center border-2 border-dashed cursor-pointer" onclick="setActiveElevation('right')">
                     <span class="text-gray-400 text-sm pointer-events-none">Upload Image</span>
                </div>
                <input type="file" id="right-upload-input" class="hidden" accept="image/png, image/jpeg">
                <button id="upload-right-button" class="mt-2 w-full px-2 py-1 bg-gray-500 text-white text-xs font-semibold rounded-lg hover:bg-gray-600 transition-colors">Upload</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <!-- Left Side: Prompt Input and Image Upload -->
            <div class="space-y-4">
                <textarea id="promptInput" rows="3" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow resize-none" placeholder="Describe the ideal surroundings for your building (e.g., 'a lush tropical garden with waterfalls' or 'a futuristic cityscape with flying cars')."></textarea>
                <div class="flex items-center justify-between space-x-2">
                    <button id="generateRenderButton" class="w-full px-4 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors">
                        <i class="fas fa-image mr-2"></i>
                        Generate New Environment
                    </button>
                </div>
            </div>

            <!-- Right Side: Structural Analysis and Output -->
            <div class="space-y-4">
                <div class="flex items-center space-x-2">
                    <button id="structuralAnalysisButton" class="w-full px-4 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors">
                        <i class="fas fa-search mr-2"></i>
                        Perform Structural Analysis
                    </button>
                    <button id="readAloudButton" class="w-auto px-4 py-3 bg-yellow-500 text-white font-semibold rounded-lg shadow-md hover:bg-yellow-600 transition-colors">
                         <i class="fas fa-volume-up"></i> âœ¨ Read Aloud
                    </button>
                </div>
                <div class="flex items-center space-x-2 mt-2">
                    <button id="generateColorPaletteButton" class="w-full px-4 py-3 bg-teal-600 text-white font-semibold rounded-lg shadow-md hover:bg-teal-700 transition-colors">
                        <i class="fas fa-swatchbook mr-2"></i>
                        âœ¨ Generate Color Palette
                    </button>
                    <button id="generateDesignIdeasButton" class="w-full px-4 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors">
                        <i class="fas fa-lightbulb mr-2"></i>
                        âœ¨ Get Design Suggestions
                    </button>
                </div>
                <div class="flex items-center space-x-2 mt-2">
                    <button id="designBriefButton" class="w-full px-4 py-3 bg-sky-600 text-white font-semibold rounded-lg shadow-md hover:bg-sky-700 transition-colors">
                        <i class="fas fa-file-alt mr-2"></i>
                        Create Design Brief
                    </button>
                    <button id="socialPostButton" class="w-full px-4 py-3 bg-rose-600 text-white font-semibold rounded-lg shadow-md hover:bg-rose-700 transition-colors">
                        <i class="fas fa-share-alt mr-2"></i>
                        âœ¨ Draft Social Post
                    </button>
                    <button id="critiqueButton" class="w-full px-4 py-3 bg-orange-500 text-white font-semibold rounded-lg shadow-md hover:bg-orange-600 transition-colors">
                        <i class="fas fa-comment-alt mr-2"></i>
                        âœ¨ Critique Design
                    </button>
                </div>
                <div class="flex items-center space-x-2 mt-2">
                    <button id="sustainabilityReportButton" class="w-full px-4 py-3 bg-cyan-600 text-white font-semibold rounded-lg shadow-md hover:bg-cyan-700 transition-colors">
                        <i class="fas fa-leaf mr-2"></i>
                        âœ¨ Get Sustainability Report
                    </button>
                    <button id="costEstimationButton" class="w-full px-4 py-3 bg-lime-600 text-white font-semibold rounded-lg shadow-md hover:bg-lime-700 transition-colors">
                        <span class="font-bold mr-2">Ksh</span>
                        âœ¨ Estimate Project Cost
                    </button>
                </div>
                <div id="structuralOutputContainer" class="p-4 bg-white rounded-lg shadow-inner border border-gray-300 min-h-[100px] overflow-auto relative">
                    <p class="text-gray-500">Analysis results will appear here after you upload an image and click 'Perform Structural Analysis'.</p>
                </div>
            </div>
        </div>
    </div>
    <audio id="audioPlayer" class="hidden"></audio>

    <script>
        const renderImageView = document.getElementById('renderImageView');
        const promptInput = document.getElementById('promptInput');
        const generateRenderButton = document.getElementById('generateRenderButton');
        const structuralAnalysisButton = document.getElementById('structuralAnalysisButton');
        const designBriefButton = document.getElementById('designBriefButton');
        const readAloudButton = document.getElementById('readAloudButton');
        const generateColorPaletteButton = document.getElementById('generateColorPaletteButton');
        const generateDesignIdeasButton = document.getElementById('generateDesignIdeasButton');
        const socialPostButton = document.getElementById('socialPostButton');
        const critiqueButton = document.getElementById('critiqueButton');
        const sustainabilityReportButton = document.getElementById('sustainabilityReportButton');
        const costEstimationButton = document.getElementById('costEstimationButton');
        const structuralOutputContainer = document.getElementById('structuralOutputContainer');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const messageBox = document.getElementById('messageBox');
        const downloadPdfButton = document.getElementById('downloadPdfButton');
        const downloadImageButton = document.getElementById('downloadImageButton');
        const clearRenderButton = document.getElementById('clearRenderButton');
        const audioPlayer = document.getElementById('audioPlayer');

        const elevationElements = {
            front: {
                thumbContainer: document.getElementById('front-thumb-container'),
                uploadInput: document.getElementById('front-upload-input'),
                uploadButton: document.getElementById('upload-front-button'),
            },
            rear: {
                thumbContainer: document.getElementById('rear-thumb-container'),
                uploadInput: document.getElementById('rear-upload-input'),
                uploadButton: document.getElementById('upload-rear-button'),
            },
            left: {
                thumbContainer: document.getElementById('left-thumb-container'),
                uploadInput: document.getElementById('left-upload-input'),
                uploadButton: document.getElementById('upload-left-button'),
            },
            right: {
                thumbContainer: document.getElementById('right-thumb-container'),
                uploadInput: document.getElementById('right-upload-input'),
                uploadButton: document.getElementById('upload-right-button'),
            },
        };

        let elevationImages = {
            front: null, // will store { base64Data, fullSrc }
            rear: null,
            left: null,
            right: null,
        };
        let activeImageId = null; // will be 'front', 'rear', 'left', or 'right'
        let analysisReportText = '';
        let renderImageSrc = '';

        const apiKey = ""; // The API key will be provided by the canvas environment

        function showMessageBox(message, type = 'info') {
            messageBox.textContent = message;
            messageBox.className = `absolute top-4 w-auto max-w-sm p-4 rounded-lg text-white font-semibold shadow-xl transition-opacity duration-300 opacity-100 block ${
                type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-gray-700'
            }`;
            setTimeout(() => {
                messageBox.className = messageBox.className.replace('opacity-100', 'opacity-0');
            }, 3000);
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 3300);
        }

        async function fetchWithRetry(url, payload) {
            const maxRetries = 3;
            let retries = 0;
            let response = null;

            do {
                try {
                    console.log(`Attempt ${retries + 1} to fetch data.`);
                    response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        return response;
                    } else {
                        throw new Error(`API returned status code: ${response.status}`);
                    }
                } catch (error) {
                    retries++;
                    console.error(`Fetch attempt ${retries} failed:`, error);
                    if (retries < maxRetries) {
                        const delay = Math.pow(2, retries) * 16000; // Increased delay to be more robust
                        console.log(`Retrying in ${delay / 1000} seconds...`);
                        await new Promise(res => setTimeout(res, delay));
                    } else {
                        console.error("Failed to fetch data after multiple retries.");
                        throw error;
                    }
                }
            } while (retries < maxRetries);

            throw new Error("Failed to fetch data after multiple retries.");
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2;
            const byteRate = sampleRate * numChannels * bytesPerSample;
            const blockAlign = numChannels * bytesPerSample;

            const buffer = new ArrayBuffer(44 + pcm16.length * 2);
            const view = new DataView(buffer);
            let offset = 0;

            function writeString(str) {
                for (let i = 0; i < str.length; i++) {
                    view.setUint8(offset++, str.charCodeAt(i));
                }
            }

            writeString('RIFF'); // RIFF identifier
            view.setUint32(offset, 36 + pcm16.length * 2, true); // file length
            offset += 4;
            writeString('WAVE'); // RIFF type
            writeString('fmt '); // format chunk identifier
            view.setUint32(offset, 16, true); // format chunk length
            offset += 4;
            view.setUint16(offset, 1, true); // audio format (1 = PCM)
            offset += 2;
            view.setUint16(offset, numChannels, true); // number of channels
            offset += 2;
            view.setUint32(offset, sampleRate, true); // sample rate
            offset += 4;
            view.setUint32(offset, byteRate, true); // byte rate
            offset += 4;
            view.setUint16(offset, blockAlign, true); // block align
            offset += 2;
            view.setUint16(offset, 16, true); // bits per sample
            offset += 2;
            writeString('data'); // data chunk identifier
            view.setUint32(offset, pcm16.length * 2, true); // data chunk length
            offset += 4;

            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }


        function handleImageUpload(elevationKey) {
            const file = elevationElements[elevationKey].uploadInput.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const fullSrc = e.target.result;
                const base64Data = fullSrc.split(',')[1];
                
                elevationImages[elevationKey] = { base64Data, fullSrc };

                const thumbContainer = elevationElements[elevationKey].thumbContainer;
                thumbContainer.innerHTML = `<img src="${fullSrc}" class="w-full h-full object-cover rounded-lg pointer-events-none">`;
                
                setActiveElevation(elevationKey);
                showMessageBox(`${elevationKey.charAt(0).toUpperCase() + elevationKey.slice(1)} image uploaded.`, 'success');
            };
            reader.readAsDataURL(file);
        }

        Object.keys(elevationElements).forEach(key => {
            elevationElements[key].uploadButton.addEventListener('click', () => {
                elevationElements[key].uploadInput.click();
            });
            elevationElements[key].uploadInput.addEventListener('change', () => {
                handleImageUpload(key);
            });
        });

        function setActiveElevation(elevationKey) {
            // Only proceed if an image has been uploaded for this elevation
            if (!elevationImages[elevationKey]) {
                showMessageBox(`Please upload an image for the ${elevationKey} elevation first.`, 'error');
                return;
            }

            activeImageId = elevationKey;
            const activeImageData = elevationImages[elevationKey];
            
            renderImageView.src = activeImageData.fullSrc;
            renderImageSrc = activeImageData.fullSrc; // Keep this in sync for downloads
            
            // Update active class on thumbnails
            Object.keys(elevationElements).forEach(key => {
                const container = elevationElements[key].thumbContainer;
                if (key === elevationKey) {
                    container.classList.add('border-blue-500', 'border-4');
                    container.classList.remove('border-dashed');
                } else {
                    container.classList.remove('border-blue-500', 'border-4');
                    if (!elevationImages[key]) {
                        container.classList.add('border-dashed');
                    }
                }
            });
        }
        
        generateRenderButton.addEventListener('click', async () => {
            const userPrompt = promptInput.value.trim();
            if (!activeImageId || !elevationImages[activeImageId]) {
                showMessageBox('Please upload and select an elevation image first.', 'error');
                return;
            }
            const activeImageData = elevationImages[activeImageId];
            
            if (!userPrompt) {
                showMessageBox('Please describe the new surroundings in the text box.', 'error');
                return;
            }

            loadingIndicator.classList.remove('hidden');
            renderImageView.style.opacity = '0.5';

            try {
                // The prompt now explicitly instructs the model to build upon the current image.
                const explicitPrompt = `Using the current image as a base, strictly maintain the structure and dimensions of the house or building. Do not add any new rooms, wings, or structural elements. The only part of the image that should change is the surroundings, which should be updated to include the following new elements: ${userPrompt}.`;

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${apiKey}`;
                const payload = {
                    contents: [{
                        parts: [
                            { text: explicitPrompt },
                            { inlineData: { mimeType: 'image/png', data: activeImageData.base64Data } }
                        ]
                    }],
                    generationConfig: {
                        responseModalities: ['IMAGE']
                    }
                };
                
                const response = await fetchWithRetry(apiUrl, payload);
                const result = await response.json();
                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (!base64Data) {
                    throw new Error('No image data received from API.');
                }

                renderImageSrc = `data:image/png;base64,${base64Data}`;
                renderImageView.src = renderImageSrc;
                // Update the base64 of the active image for the next render
                elevationImages[activeImageId] = { base64Data: base64Data, fullSrc: renderImageSrc };
                // Update the thumbnail too
                elevationElements[activeImageId].thumbContainer.innerHTML = `<img src="${renderImageSrc}" class="w-full h-full object-cover rounded-lg pointer-events-none">`;
                showMessageBox('New environment generated successfully!', 'success');

            } catch (error) {
                console.error("Error generating new environment:", error);
                showMessageBox(`Error: ${error.message}`, 'error');
            } finally {
                loadingIndicator.classList.add('hidden');
                renderImageView.style.opacity = '1';
            }
        });

        structuralAnalysisButton.addEventListener('click', async () => {
            const userPrompt = "Analyze the structural and design elements of the image, including geometry, materials, and potential engineering challenges. Provide the analysis report in Markdown format, using LaTeX for all mathematical expressions. Do not use conversational filler, just provide the analysis report.";
            
            const analysisImageBase64 = activeImageId ? elevationImages[activeImageId]?.base64Data : null;

            if (!analysisImageBase64) {
                showMessageBox('Please upload and select an image first.', 'error');
                return;
            }

            loadingIndicator.classList.remove('hidden');
            renderImageView.style.opacity = '0.5';

            try {
                const payload = {
                    contents: [{
                        parts: [
                            { text: userPrompt },
                            { inlineData: { mimeType: 'image/png', data: analysisImageBase64 } }
                        ]
                    }],
                    model: 'gemini-2.5-flash-preview-05-20'
                };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetchWithRetry(apiUrl, payload);
                const result = await response.json();
                const analysisText = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'No analysis could be performed.';

                analysisReportText = analysisText;
                let formattedOutput = marked.parse(analysisReportText);
                
                structuralOutputContainer.innerHTML = `
                    <h2 class="text-xl font-semibold mb-2">Structural Analysis Report</h2>
                    <div class="p-4 bg-white rounded-lg shadow-md mt-4 prose max-w-none relative">
                        ${formattedOutput}
                        <button onclick="copyOutputText()" class="absolute top-2 right-2 px-3 py-1 bg-gray-200 text-gray-600 rounded-full shadow-md hover:bg-gray-300 transition-colors">
                            <i class="fas fa-copy mr-1"></i> Copy
                        </button>
                    </div>
                `;

                // Trigger MathJax rendering
                if (window.MathJax) {
                    window.MathJax.typesetPromise();
                }

            } catch (error) {
                console.error("Error performing structural analysis:", error);
                structuralOutputContainer.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-lg">Error: ${error.message}</div>`;
            } finally {
                loadingIndicator.classList.add('hidden');
                renderImageView.style.opacity = '1';
            }
        });
        
        designBriefButton.addEventListener('click', async () => {
            const analysisImageBase64 = activeImageId ? elevationImages[activeImageId]?.base64Data : null;

            if (!analysisImageBase64) {
                showMessageBox('Please upload and select an image first.', 'error');
                return;
            }

            loadingIndicator.classList.remove('hidden');
            renderImageView.style.opacity = '0.5';

            try {
                const userPrompt = "Generate a concise, professional design brief for the attached image. The brief should include a title, its intended purpose, key aesthetic elements, and a list of three potential materials. Format the response using Markdown. Do not use conversational filler, just provide the brief.";
                const payload = {
                    contents: [{
                        parts: [
                            { text: userPrompt },
                            { inlineData: { mimeType: 'image/png', data: analysisImageBase64 } }
                        ]
                    }],
                    model: 'gemini-2.5-flash-preview-05-20'
                };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetchWithRetry(apiUrl, payload);
                const result = await response.json();
                const briefText = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'No brief could be generated.';

                let formattedOutput = marked.parse(briefText);
                
                structuralOutputContainer.innerHTML = `
                    <h2 class="text-xl font-semibold mb-2">Design Brief</h2>
                    <div class="p-4 bg-white rounded-lg shadow-md mt-4 prose max-w-none relative">
                        ${formattedOutput}
                        <button onclick="copyOutputText()" class="absolute top-2 right-2 px-3 py-1 bg-gray-200 text-gray-600 rounded-full shadow-md hover:bg-gray-300 transition-colors">
                            <i class="fas fa-copy mr-1"></i> Copy
                        </button>
                    </div>
                `;

            } catch (error) {
                console.error("Error creating design brief:", error);
                structuralOutputContainer.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-lg">Error: ${error.message}</div>`;
            } finally {
                loadingIndicator.classList.add('hidden');
                renderImageView.style.opacity = '1';
            }
        });

        readAloudButton.addEventListener('click', async () => {
            if (!analysisReportText) {
                showMessageBox('No analysis report to read. Please run a structural analysis first.', 'error');
                return;
            }

            const promptText = `Please read the following text aloud: ${analysisReportText}`;

            loadingIndicator.classList.remove('hidden');
            renderImageView.style.opacity = '0.5';

            try {
                const payload = {
                    contents: [{
                        parts: [{ text: promptText }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Kore" }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

                const response = await fetchWithRetry(apiUrl, payload);
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    audioPlayer.src = audioUrl;
                    audioPlayer.play();
                    showMessageBox('Playing analysis report.', 'success');
                } else {
                    throw new Error("Invalid audio data received.");
                }

            } catch (error) {
                console.error("Error reading aloud:", error);
                showMessageBox(`Error: ${error.message}`, 'error');
            } finally {
                loadingIndicator.classList.add('hidden');
                renderImageView.style.opacity = '1';
            }
        });
        
        generateColorPaletteButton.addEventListener('click', async () => {
            const imageBase64 = activeImageId ? elevationImages[activeImageId]?.base64Data : null;

            if (!imageBase64) {
                showMessageBox('Please upload and select an image first.', 'error');
                return;
            }

            loadingIndicator.classList.remove('hidden');
            renderImageView.style.opacity = '0.5';

            try {
                const prompt = "Analyze the dominant colors in this image. Provide a title, and a list of 5 to 6 hex codes with a short, descriptive name for each color. Format the response as a JSON object with 'title' and 'palette' keys. Do not include conversational text.";

                const payload = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType: 'image/png', data: imageBase64 } }
                        ]
                    }],
                    model: 'gemini-2.5-flash-preview-05-20',
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "title": { "type": "STRING" },
                                "palette": {
                                    "type": "ARRAY",
                                    "items": {
                                        "type": "OBJECT",
                                        "properties": {
                                            "name": { "type": "STRING" },
                                            "hex": { "type": "STRING" }
                                        },
                                        "propertyOrdering": ["name", "hex"]
                                    }
                                }
                            }
                        }
                    }
                };
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetchWithRetry(apiUrl, payload);
                const result = await response.json();
                const jsonText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                const paletteData = JSON.parse(jsonText);

                if (!paletteData || !paletteData.palette) {
                    throw new Error('Invalid palette data received.');
                }

                let paletteHTML = `<h2 class="text-xl font-semibold mb-4">${paletteData.title}</h2><div class="flex flex-wrap gap-4 mt-4">`;
                paletteData.palette.forEach(color => {
                    paletteHTML += `
                        <div class="flex flex-col items-center">
                            <div class="w-16 h-16 rounded-full border-2 border-gray-300 shadow-lg" style="background-color: ${color.hex};"></div>
                            <span class="mt-2 text-sm font-medium text-gray-700">${color.name}</span>
                            <span class="text-xs text-gray-500">${color.hex}</span>
                        </div>
                    `;
                });
                paletteHTML += `</div>`;
                
                structuralOutputContainer.innerHTML = paletteHTML;

            } catch (error) {
                console.error("Error generating color palette:", error);
                structuralOutputContainer.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-lg">Error: ${error.message}</div>`;
            } finally {
                loadingIndicator.classList.add('hidden');
                renderImageView.style.opacity = '1';
            }
        });
        
        generateDesignIdeasButton.addEventListener('click', async () => {
            const imageBase64 = activeImageId ? elevationImages[activeImageId]?.base64Data : null;

            if (!imageBase64) {
                showMessageBox('Please upload and select an image first.', 'error');
                return;
            }

            loadingIndicator.classList.remove('hidden');
            renderImageView.style.opacity = '0.5';

            try {
                // New prompt to analyze surroundings and integrate them into the design
                const prompt = "Analyze the architectural design and the natural surroundings in the attached image, identifying the key aesthetic elements of the environment (e.g., colors, textures, materials, shapes of nature). Propose design suggestions for the building that seamlessly integrate these 'beautiful surroundings.' Generate three unique, detailed text prompts that could be used to render an updated version of this design, showcasing the new, integrated elements. Format the response in Markdown with a clear heading for 'Architectural Integration with Surroundings' followed by a bulleted or numbered list of the new prompts for rendering. Do not include conversational filler, just provide the analysis and prompts.";
                
                const payload = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType: 'image/png', data: imageBase64 } }
                        ]
                    }],
                    model: 'gemini-2.5-flash-preview-05-20'
                };
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetchWithRetry(apiUrl, payload);
                const result = await response.json();
                const ideasText = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'No design suggestions could be generated.';

                let formattedOutput = marked.parse(ideasText);
                
                structuralOutputContainer.innerHTML = `
                    <h2 class="text-xl font-semibold mb-2">Design Suggestions</h2>
                    <div class="p-4 bg-white rounded-lg shadow-md mt-4 prose max-w-none relative">
                        ${formattedOutput}
                        <button onclick="copyOutputText()" class="absolute top-2 right-2 px-3 py-1 bg-gray-200 text-gray-600 rounded-full shadow-md hover:bg-gray-300 transition-colors">
                            <i class="fas fa-copy mr-1"></i> Copy
                        </button>
                    </div>
                `;
            
            } catch (error) {
                console.error("Error generating design ideas:", error);
                structuralOutputContainer.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-lg">Error: ${error.message}</div>`;
            } finally {
                loadingIndicator.classList.add('hidden');
                renderImageView.style.opacity = '1';
            }
        });
        
        socialPostButton.addEventListener('click', async () => {
            const imageBase64 = activeImageId ? elevationImages[activeImageId]?.base64Data : null;

            if (!imageBase64) {
                showMessageBox('Please upload and select an image first.', 'error');
                return;
            }

            loadingIndicator.classList.remove('hidden');
            renderImageView.style.opacity = '0.5';

            try {
                const prompt = "Draft a creative and engaging social media post for this design. The post should include a compelling caption, relevant hashtags, and a clear call-to-action. Format the response using Markdown. Do not include conversational filler, just provide the post.";
                
                const payload = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType: 'image/png', data: imageBase64 } }
                        ]
                    }],
                    model: 'gemini-2.5-flash-preview-05-20'
                };
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetchWithRetry(apiUrl, payload);
                const result = await response.json();
                const postText = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'Could not generate a social media post.';

                let formattedOutput = marked.parse(postText);
                
                structuralOutputContainer.innerHTML = `
                    <h2 class="text-xl font-semibold mb-2">Drafted Social Post</h2>
                    <div class="p-4 bg-white rounded-lg shadow-md mt-4 prose max-w-none relative">
                        ${formattedOutput}
                        <button onclick="copyOutputText()" class="absolute top-2 right-2 px-3 py-1 bg-gray-200 text-gray-600 rounded-full shadow-md hover:bg-gray-300 transition-colors">
                            <i class="fas fa-copy mr-1"></i> Copy
                        </button>
                    </div>
                `;
            
            } catch (error) {
                console.error("Error drafting social post:", error);
                structuralOutputContainer.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-lg">Error: ${error.message}</div>`;
            } finally {
                loadingIndicator.classList.add('hidden');
                renderImageView.style.opacity = '1';
            }
        });

        critiqueButton.addEventListener('click', async () => {
            const imageBase64 = activeImageId ? elevationImages[activeImageId]?.base64Data : null;

            if (!imageBase64) {
                showMessageBox('Please upload and select an image first.', 'error');
                return;
            }

            loadingIndicator.classList.remove('hidden');
            renderImageView.style.opacity = '0.5';

            try {
                const prompt = "Provide a constructive design critique of the image. Identify 2-3 key strengths and 2-3 areas for improvement. Use markdown formatting to clearly separate the sections. Do not include conversational filler, just provide the critique.";
                
                const payload = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType: 'image/png', data: imageBase64 } }
                        ]
                    }],
                    model: 'gemini-2.5-flash-preview-05-20'
                };
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetchWithRetry(apiUrl, payload);
                const result = await response.json();
                const critiqueText = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'Could not generate a design critique.';

                let formattedOutput = marked.parse(critiqueText);
                
                structuralOutputContainer.innerHTML = `
                    <h2 class="text-xl font-semibold mb-2">Design Critique</h2>
                    <div class="p-4 bg-white rounded-lg shadow-md mt-4 prose max-w-none relative">
                        ${formattedOutput}
                        <button onclick="copyOutputText()" class="absolute top-2 right-2 px-3 py-1 bg-gray-200 text-gray-600 rounded-full shadow-md hover:bg-gray-300 transition-colors">
                            <i class="fas fa-copy mr-1"></i> Copy
                        </button>
                    </div>
                `;
            
            } catch (error) {
                console.error("Error generating design critique:", error);
                structuralOutputContainer.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-lg">Error: ${error.message}</div>`;
            } finally {
                loadingIndicator.classList.add('hidden');
                renderImageView.style.opacity = '1';
            }
        });

        sustainabilityReportButton.addEventListener('click', async () => {
            const imageBase64 = activeImageId ? elevationImages[activeImageId]?.base64Data : null;

            if (!imageBase64) {
                showMessageBox('Please upload and select an image first.', 'error');
                return;
            }

            loadingIndicator.classList.remove('hidden');
            renderImageView.style.opacity = '0.5';

            try {
                const prompt = "Act as a sustainable design consultant. Analyze the building and its environment in the image. Provide a sustainability report in Markdown format. The report should include suggestions for: 1. Energy efficiency (e.g., solar panels, insulation). 2. Water conservation (e.g., rainwater harvesting). 3. Sustainable materials. 4. Integrating nature (e.g., green roofs, living walls). Do not use conversational filler, just provide the report.";
                
                const payload = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType: 'image/png', data: imageBase64 } }
                        ]
                    }],
                    model: 'gemini-2.5-flash-preview-05-20'
                };
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetchWithRetry(apiUrl, payload);
                const result = await response.json();
                const reportText = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'Could not generate a sustainability report.';

                let formattedOutput = marked.parse(reportText);
                
                structuralOutputContainer.innerHTML = `
                    <h2 class="text-xl font-semibold mb-2">Sustainability Report</h2>
                    <div class="p-4 bg-white rounded-lg shadow-md mt-4 prose max-w-none relative">
                        ${formattedOutput}
                        <button onclick="copyOutputText()" class="absolute top-2 right-2 px-3 py-1 bg-gray-200 text-gray-600 rounded-full shadow-md hover:bg-gray-300 transition-colors">
                            <i class="fas fa-copy mr-1"></i> Copy
                        </button>
                    </div>
                `;
            
            } catch (error) {
                console.error("Error generating sustainability report:", error);
                structuralOutputContainer.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-lg">Error: ${error.message}</div>`;
            } finally {
                loadingIndicator.classList.add('hidden');
                renderImageView.style.opacity = '1';
            }
        });

        costEstimationButton.addEventListener('click', async () => {
            const imageBase64 = activeImageId ? elevationImages[activeImageId]?.base64Data : null;

            if (!imageBase64) {
                showMessageBox('Please upload and select an image first.', 'error');
                return;
            }

            loadingIndicator.classList.remove('hidden');
            renderImageView.style.opacity = '0.5';

            try {
                const prompt = "Act as a professional quantity surveyor in Kenya. Based on the visual information in the image (materials, size, complexity), provide a high-level, preliminary cost estimation for this building project in Kenyan Shillings (KSH). Use Google Search to find the latest prices for building materials in Kenya to ensure the estimate is as current as possible. Break down the estimate into categories (e.g., Foundation, Structure, Exterior Finishes, Roofing, Windows & Doors). Provide a total estimated cost range. Format the report in Markdown. Add a clear disclaimer that this is a rough estimate based on visual analysis and real-time search data, and a professional quote is required for accuracy. Do not use conversational filler, just provide the estimate.";
                
                const payload = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            { inlineData: { mimeType: 'image/png', data: imageBase64 } }
                        ]
                    }],
                    tools: [{ "google_search": {} }],
                    model: 'gemini-2.5-flash-preview-05-20'
                };
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const response = await fetchWithRetry(apiUrl, payload);
                const result = await response.json();
                const estimateText = result?.candidates?.[0]?.content?.parts?.[0]?.text || 'Could not generate a cost estimate.';

                let formattedOutput = marked.parse(estimateText);
                
                structuralOutputContainer.innerHTML = `
                    <h2 class="text-xl font-semibold mb-2">Preliminary Cost Estimate</h2>
                    <div class="p-4 bg-white rounded-lg shadow-md mt-4 prose max-w-none relative">
                        ${formattedOutput}
                        <button onclick="copyOutputText()" class="absolute top-2 right-2 px-3 py-1 bg-gray-200 text-gray-600 rounded-full shadow-md hover:bg-gray-300 transition-colors">
                            <i class="fas fa-copy mr-1"></i> Copy
                        </button>
                    </div>
                `;
            
            } catch (error) {
                console.error("Error generating cost estimate:", error);
                structuralOutputContainer.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-lg">Error: ${error.message}</div>`;
            } finally {
                loadingIndicator.classList.add('hidden');
                renderImageView.style.opacity = '1';
            }
        });

        downloadPdfButton.addEventListener('click', () => {
            if (!renderImageSrc && !structuralOutputContainer.textContent) {
                showMessageBox('No report or render to download.', 'error');
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text("AI Designer Report", 10, 10);

            let yOffset = 20;

            if (renderImageSrc) {
                const img = new Image();
                img.onload = () => {
                    const imgWidth = 180;
                    const imgHeight = (img.height * imgWidth) / img.width;
                    if (yOffset + imgHeight > 280) { // Check if new page is needed
                        doc.addPage();
                        yOffset = 20;
                    }
                    doc.addImage(img, 'JPEG', 15, yOffset, imgWidth, imgHeight);
                    yOffset += imgHeight + 10;
                    addTextToPdf(doc, structuralOutputContainer.textContent, yOffset);
                    doc.save("Loveth_AI_Designer_Report.pdf");
                };
                img.src = renderImageSrc;
            } else {
                addTextToPdf(doc, structuralOutputContainer.textContent, yOffset);
                doc.save("Loveth_AI_Designer_Report.pdf");
            }
        });

        downloadImageButton.addEventListener('click', () => {
            const imageSrc = renderImageView.src;
            if (imageSrc.includes('placehold.co')) {
                showMessageBox('No image to download. Please generate a render first.', 'error');
                return;
            }
            
            const link = document.createElement('a');
            link.href = imageSrc;
            link.download = 'Loveth_AI_Render.png';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showMessageBox('Image download started!', 'success');
        });

        clearRenderButton.addEventListener('click', () => {
            // Reset state variables
            elevationImages = { front: null, rear: null, left: null, right: null };
            activeImageId = null;
            renderImageSrc = '';
            analysisReportText = '';

            // Reset UI elements to their initial state
            renderImageView.src = 'https://placehold.co/1280x720/e2e8f0/94a3b8?text=Your+AI+Render+Here';
            structuralOutputContainer.innerHTML = `<p class="text-gray-500">Analysis results will appear here after you upload an image and click 'Perform Structural Analysis'.</p>`;
            
            // Reset elevation thumbnails
            Object.keys(elevationElements).forEach(key => {
                const thumbContainer = elevationElements[key].thumbContainer;
                thumbContainer.innerHTML = `<span class="text-gray-400 text-sm pointer-events-none">Upload Image</span>`;
                thumbContainer.classList.remove('border-blue-500', 'border-4');
                thumbContainer.classList.add('border-dashed');
            });
            
            showMessageBox('Render and analysis cleared. Please upload new images.', 'success');
        });

        function addTextToPdf(doc, text, yOffset) {
            if (text) {
                doc.setFontSize(12);
                const lines = doc.splitTextToSize(text, 180);
                lines.forEach(line => {
                    if (yOffset > 280) { // Check if new page is needed
                        doc.addPage();
                        yOffset = 20;
                    }
                    doc.text(line, 15, yOffset);
                    yOffset += 7; // Line height
                });
            }
        }
        
        function copyOutputText() {
            const container = document.querySelector('#structuralOutputContainer .prose');
            if (!container) return;

            // Use a temporary textarea to hold the content for copying
            const tempTextArea = document.createElement('textarea');
            // Remove button text from the copied content
            tempTextArea.value = container.textContent.replace(/Copy/g, '').trim(); 
            document.body.appendChild(tempTextArea);
            tempTextArea.select();
            
            try {
                document.execCommand('copy');
                showMessageBox('Text copied to clipboard!', 'success');
            } catch (err) {
                console.error('Failed to copy text', err);
                showMessageBox('Failed to copy text. Please try again.', 'error');
            } finally {
                document.body.removeChild(tempTextArea);
            }
        }
    </script>
</body>
</html>


